---
title: "Part 2"
author: "Pedro Lins"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
############
# Packages #
############
library(plyr)
library(gapminder)
library(tidyverse)
library(knitr)
library(ggplot2)
library(lmtest) # tests
library(MASS) # boxcox
library(nortest) #ad.test for resifual normality 
library(PerformanceAnalytics) # correlation map
library(car) #variance factorinflation factor
```

```{r}
#############
# Load Data #
#############
openpowerlifting = "openpowerlifting.csv" 
df = read_csv(openpowerlifting)
```


```{r}
#####################
# Checking the data #
#####################
#understand the quirks of the data set and potential errors

head(df) #looking at data
summary(df) #checking data

str(df)
sapply(lapply(df, unique), length)
```


```{r}
#############################
# Exploratory Data Analysis #
#############################
#to understand properties of the data
#to inspect qualitative features rather than a huge table of raw data
#to discover new patterns or associations

#quantitative variables: Age,Bodyweight, Squat (1,2,3), Bench (1,2,3), Deadlift(1,2,3), Total,  Dots, Wilks Glossbrenner, Goodlift, Date, Year


ggplot(df,aes(x = Squat1Kg, y= TotalKg, color = Equipment))+
  geom_point(alpha = 0.6) +
  theme_minimal()+
  ggtitle("Scatterplot: Squat x TotalKg")

ggplot(df,aes(x = Sex, y = Wilks, fill = Sex)) +
  geom_violin(alpha = 0.6) +
  theme_minimal() + 
  ggtitle("Violin: Wilks")

ggplot(df,aes(x = Sex, y = Wilks, fill = Sex)) +
  geom_boxplot(alpha = 0.6) +
  theme_minimal() + 
  ggtitle("Boxplot: TotalKg")
```


```{r}
######################################
# Statistical modeling and inference #
######################################

# I did it because date was in DD/MM/YYYY format, to make it easier for analyse, I made it just YYYY. 
df$Year = c(format(df$Date, "%Y"))
df$Year = as.numeric(df$Year)

df2 = df %>%
  filter(MeetName == "World Classic Powerlifting Championships") %>%
  filter(Squat1Kg > 0) %>%
  filter(Bench1Kg > 0) %>%
  filter(Deadlift1Kg > 0) %>%
  filter(Year == 2019) 

summary(df2) # looking for NAs
str(df2) # looking for NAs
df2=df2[-c(14,19,24,34,39)] #drop NAs  columns
df2 = na.omit(df2) #drop NAs rows
sapply(lapply(df2, unique), length)
df2=df2[-c(1,3,4,6,7,8,10,12:14,16:18,20:22,24:37)] #drop single values variable
sapply(lapply(df2, unique), length)

dfcor = data.frame(df2$Bench1Kg, df2$Squat1Kg, df2$Deadlift1Kg, df2$Age, df2$BodyweightKg)
chart.Correlation(dfcor, histogram=TRUE, pch=19) #has to be lower than 70%

mod = lm(TotalKg ~ ., df2) #first try
summary(mod)

mod = lm(TotalKg ~ . - Age, df2) #removing Age
summary(mod)

mod = lm(TotalKg ~ . - Sex - Age, df2) #removing Age
summary(mod)

mod = lm(TotalKg ~ BodyweightKg + Squat1Kg + Bench1Kg + Deadlift1Kg, df2) #second try
summary(mod)

mod = lm(TotalKg ~ Bench1Kg + Deadlift1Kg, df2)
mod = lm(TotalKg ~ Bench1Kg + Squat1Kg, df2)
summary(mod)

#collinearity
vif = vif(mod)  #should be lower than 5
barplot(vif, main = "VIF Values" ,col = "blue")
abline( h = 5, col = "red") #remove squat since it has the higest VIF

mod = lm(TotalKg ~ . - Squat1Kg, df2) #removing first squat
summary(mod)

mod = lm(TotalKg ~ . - Squat1Kg - Sex, df2) #removing first squat
summary(mod)

#collinearity
vif = vif(mod)  #should be lower than 5
barplot(vif, main = "VIF Values" ,col = "blue") #without Squat1Kg
abline( h = 5, col = "red") 


#####################
# Residual analysis #
#####################
anares = rstandard(mod)

# normality test for residues
ad.test(anares) # normal if greater than 0.05
shapiro.test(anares) #normal if greater than 0.05

# homoscedasticity test
bptest(mod) #fail to reject the null hypothesis (p-value > 0.05)

# autocorrelation test
dwtest(mod) #should be between 1.50 and 2.50

# define plotting area
par(mfrow=c(2,2))

# plot residual analysis
plot(aov(mod)) 

df2 = df2[-45,] #removing outlier

mod = lm(TotalKg ~ . - Squat1Kg - Sex, df2) #removing first squat
summary(mod)

anares = rstandard(mod)

# normality test for residues
ad.test(anares) # normal if greater than 0.05
shapiro.test(anares) #normal if greater than 0.05

# homoscedasticity test
bptest(mod) #fail to reject the null hypothesis (p-value > 0.05)

# autocorrelation test
dwtest(mod) #should be between 1.50 and 2.50

# define plotting area
par(mfrow=c(2,2))

# plot residual analysis
plot(aov(mod)) 


```

```{r}
#changing strategies

df2 = df %>%
  filter(MeetName == "World Classic Powerlifting Championships") %>%
  filter(Squat1Kg > 0) %>%
  filter(Bench1Kg > 0) %>%
  filter(Deadlift1Kg > 0) %>%
  filter(Year == 2019)  %>%
  filter(WeightClassKg == "120+")

summary(df2) # looking for NAs
str(df2) # looking for NAs
df2=df2[-c(14,19,24,34,39)] #drop NAs  columns
df2 = na.omit(df2) #drop NAs rows
sapply(lapply(df2, unique), length)
df2=df2[-c(1,3,4,6,7,8,10,12:14,16:18,20:22,24:37)] #drop single values variable
sapply(lapply(df2, unique), length)

dfcor = data.frame(df2$Bench1Kg, df2$Squat1Kg, df2$Deadlift1Kg, df2$Age, df2$BodyweightKg)
chart.Correlation(dfcor, histogram=TRUE, pch=19) #has to be lower than 70%
```


```{r}
###################################
# Prediction and machine learning #
###################################

predict = predict(mod, df2, interval="confidence") #confidence
pred2 =data.frame(df7$TotalKg, predict)

sd(predicao$erro)
which.max(predicao$erro)

ggplot(predicao, aes(TotalKg, fit))+
  geom_point()+
    stat_smooth(method = lm)+
  theme_bw()
```

